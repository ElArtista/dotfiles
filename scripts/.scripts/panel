#!/usr/bin/bash

#################################################################
#-
#=- Configuration
#-
#################################################################

# File locations
PANEL_FIFO=/tmp/panel-fifo
MSGFILE=$HOME/.weechat/highlights.txt

# Hardware
WIFI_INTERFACE="wlan0"
POWERSUPPLY="/sys/class/power_supply/AC0"
BATTERY="/sys/class/power_supply/BAT0"

#################################################################
#-
#=- Customization
#-
#################################################################

# Dimensions
PANEL_HEIGHT=24

# Fonts
PANEL_FONT="Source Sans Pro:size=10"
ICON_FONT="FontAwesome:size=13"

#
# Colors
#

# Bar colors
COLOR_FOREGROUND='#dedede'
COLOR_BACKGROUND='#2b2b2b'
COLOR_ACTIVE_MONITOR_FG='#ff252527'
COLOR_ACTIVE_MONITOR_BG='#ff98971a'
COLOR_INACTIVE_MONITOR_FG='#ffa89984'
COLOR_INACTIVE_MONITOR_BG='#2b2b2b'
COLOR_FOCUSED_OCCUPIED_FG='#dedede'
COLOR_FOCUSED_OCCUPIED_BG='#ff458588'
COLOR_FOCUSED_FREE_FG='#dedede'
COLOR_FOCUSED_FREE_BG='#ff323a44'
COLOR_FOCUSED_URGENT_FG='#ff252527'
COLOR_FOCUSED_URGENT_BG='#fff9a299'
COLOR_OCCUPIED_FG='#ffd5c4a1'
COLOR_OCCUPIED_BG='#2b2b2b'
COLOR_FREE_FG='#ff928374'
COLOR_FREE_BG='#2b2b2b'
COLOR_URGENT_FG='#fff9a299'
COLOR_URGENT_BG='#ff252527'
COLOR_LAYOUT_FG='#ffeddbb2'
COLOR_LAYOUT_BG='#ff252527'
COLOR_TITLE_FG='#ffeddbb2'
COLOR_TITLE_BG='#2b2b2b'
COLOR_STATUS_FG='#dedede'
COLOR_STATUS_BG='#2b2b2b'

# Wifi signal colors
COLOR_SIGNAL_NONE='#ffebdbb2'
COLOR_SIGNAL_LOW='#ff7c6f64'
COLOR_SIGNAL_MEDIUM='#ff928374'
COLOR_SIGNAL_HIGH='#ffebdbb2'

#
# Icons
#

# Battery & Power related icons
ICON_BATT_FULL='\uf240'
ICON_BATT_HIGH='\uf241'
ICON_BATT_MED='\uf242'
ICON_BATT_LOW='\uf243'
ICON_BATT_EMPTY='\uf244'
ICON_POWER_PLUG='\uf1e6'

# Music player icons
ICON_PREV='\uf048'
ICON_PLAY='\uf04b'
ICON_NEXT='\uf051'

# Volume icons
ICON_VOL_UP='\uf028'
ICON_VOL_DOWN='\uf027'
ICON_VOL_OFF='\uf026'

# Chat icons
ICON_CHAT_CLEAR='\uf075'
ICON_CHAT_BUSY='\uf0e5'

# Signal icons
ICON_WIFI='\uf1eb'

#################################################################
#-
#=- Setup
#-
#################################################################

# Check if panel is already running
if [[ $(pgrep -cx panel) -gt 1 ]]; then
    printf "%s\n" "The panel is already running." >&2
    exit 1
fi

# Exit gracefully if terminated
deinit(){
    # Reset bspwm top_padding
    bspc config top_padding 0
    trap - TERM; kill 0
}
trap deinit INT TERM QUIT EXIT

# Remove old panel fifo, create new one
[ -e "$PANEL_FIFO" ] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"

# Set up bspwm to not overlap the panel
bspc config top_padding "$PANEL_HEIGHT"

# Get bspwms status feed
bspc control --subscribe > "$PANEL_FIFO" &

# Window title
xtitle -sf 'TITLE%s' > "$PANEL_FIFO" &

#################################################################
#-
#=- Info collectors
#-
#################################################################

# Clock
clock(){
    echo -e "$(date +"%l:%M %p")"
}

# Date
cal(){
    echo -e "$(date +'%a, %b %d')"
}

# Battery
battery(){
    if [ -f $POWERSUPPLY ]; then
        local batt_icon=""
        local batt_level=$(acpi -b | grep -o '[[:digit:]]\+%' | sed 's/%//')
        if [[ $(cat $POWERSUPPLY/online) != 1 ]]; then
            if [[ $batt_level -ge 80 ]]; then
                batt_icon=$ICON_BATT_FULL
            elif [[ $batt_level -ge 60 && $batt_level -lt 80 ]]; then
                batt_icon=$ICON_BATT_HIGH
            elif [[ $batt_level -ge 40 && $batt_level -lt 60 ]]; then
                batt_icon=$ICON_BATT_MED
            elif [[ $batt_level -ge 20 && $batt_level -lt 40 ]]; then
                batt_icon=$ICON_BATT_LOW
            elif [[ $batt_level -lt 20 ]]; then
                batt_icon=$ICON_BATT_EMPTY
            fi
        else
            batt_icon=$ICON_POWER_PLUG
        fi
        # Uncomment next and delete the line after that to see percentage
        #echo -e $batt_icon $batt_level%
        echo -e $batt_icon
    fi
}

# Alsa volume
volume(){
    local alsa_volume=$(amixer get Master | grep 'Mono: Playback' | grep -o '...%' | sed 's/\[//' | sed 's/%//' | sed 's/ //')
    local alsa_state=$(amixer get Master | grep 'Mono: Playback' | grep -o '\[on]')

    if [[ $alsa_state ]]; then
        local volume_icon=""
        if [[ $alsa_volume -ge 70 ]]; then
            volume_icon=$ICON_VOL_UP
        elif [[ $alsa_volume -gt 0 && $alsa_volume -lt 70 ]]; then
            volume_icon=$ICON_VOL_DOWN
        elif [[ $alsa_volume -eq 0 ]]; then
            volume_icon=$ICON_VOL_OFF
        else
            volume_icon=$ICON_VOL_OFF
        fi
        # Uncomment next and delte the line after that to see volume percentage
        #echo -e $volume_icon $alsa_volume
        echo -e $volume_icon
    fi
}

# Weechat (use hl2file weechat script)
weechat(){
    if [ -f "$MSGFILE" ]; then
        local weechat_icon=""
        local unreadmessages=$(wc -l < "$MSGFILE")
        if [[ $unreadmessages != 0 ]]; then
            weechat_icon="$ICON_CHAT_BUSY[$unreadmessages]"
        else
            weechat_icon=$ICON_CHAT_CLEAR
        fi
        echo -e $weechat_icon
    fi
}

# Wifi
wifi(){
    if (command -v iw >/dev/null 2>&1) && (iw dev $WIFI_INTERFACE link >/dev/null 2>&1); then
        #local wifi_ssid=$(iw $WIFI_INTERFACE link | grep 'SSID' | sed 's/SSID: //' | sed 's/\t//')
        local wifi_color=""
        local wifi_signal=$(iw dev "$WIFI_INTERFACE" link | grep 'signal' | sed 's/signal: //' | sed 's/ dBm//' | sed 's/\t//')
        if [ $? -eq 0 ]; then
            if [[ $(iw dev "$WIFI_INTERFACE" link) != "Not connected." ]]; then
                if [[ $wifi_signal -ge -67 ]]; then
                    wifi_color=$COLOR_SIGNAL_HIGH
                elif [[ $wifi_signal -ge -70 && $wifi_signal -lt -67 ]]; then
                    wifi_color=$COLOR_SIGNAL_MEDIUM
                elif [[ $wifi_signal -ge -80 && $wifi_signal -lt -70 ]]; then
                    wifi_color=$COLOR_SIGNAL_LOW
                fi
                echo -e "%{F$wifi_color}$ICON_WIFI%{F-}"
            else
                wifi_color=$COLOR_SIGNAL_NONE
                echo -e "%{F$wifi_color}$ICON_WIFI%{F-}"
            fi
        fi
    fi
}

# Music controls
music(){
    local song_name=$(mpc current)
    if [[ -n $song_name ]]; then
        if mpc status | grep -q 'paused'; then
            # Music is paused
            echo -e "%{F$COLOR_INACTIVE_MONITOR_FG}%{A:mpc play:}$song_name%{A}%{F-}"
        else
            # Music is playing
            echo -e "%{F$COLOR_FOCUSED_OCCUPIED_FG}%{A:mpc pause:}$song_name%{A}%{F-}"
        fi
    fi
}

while true; do
    echo "UPDATE"
    sleep 1;
done > "$PANEL_FIFO" &

panel_bar() {
    num_mon=$(bspc query -M | wc -l)
    PADDING="  "

    while read -r line ; do
        case $line in
            UPDATE)
                # Update polled state
                local clock=$(clock)
                local date=$(cal)
                local battery=$(battery)
                local volume=$(volume)
                local messages=$(weechat)
                local wifi=$(wifi)
                local music=$(music)
                ;;
            TITLE*)
                # Xtitle output
                local title="${line#?????}"
                ;;
            W*)
                # Bspwm internal state
                IFS=':'
                local wm_infos=""
                set -- ${line#?}
                while [ $# -gt 0 ]; do
                    item=$1
                    name=${item#?}
                    case $item in
                        M*)
                            # Active monitor
                            if [ $num_mon -gt 1 ] ; then
                                wm_infos="$wm_infos %{F$COLOR_ACTIVE_MONITOR_FG}%{B$COLOR_ACTIVE_MONITOR_BG}  ${name}  %{B-}%{F-}"
                            fi
                            ;;
                        m*)
                            # Inactive monitor
                            if [ $num_mon -gt 1 ] ; then
                                wm_infos="$wm_infos %{F$COLOR_INACTIVE_MONITOR_FG}%{B$COLOR_INACTIVE_MONITOR_BG}  ${name}  %{B-}%{F-}"
                            fi
                            ;;
                        O*)
                            # Focused occupied desktop
                            wm_infos="${wm_infos}%{F$COLOR_FOCUSED_OCCUPIED_FG}%{B$COLOR_FOCUSED_OCCUPIED_BG}%{U$COLOR_FOREGROUND}%{+u}  ${name}  %{-u}%{B-}%{F-}"
                            ;;
                        F*)
                            # Focused free desktop
                            wm_infos="${wm_infos}%{F$COLOR_FOCUSED_FREE_FG}%{B$COLOR_FOCUSED_FREE_BG}%{U$COLOR_FOREGROUND}%{+u}  ${name}  %{-u}%{B-}%{F-}"
                            ;;
                        U*)
                            # Focused urgent desktop
                            wm_infos="${wm_infos}%{F$COLOR_FOCUSED_URGENT_FG}%{B$COLOR_FOCUSED_URGENT_BG}%{U$COLOR_FOREGROUND}%{+u}  ${name}  %{-u}%{B-}%{F-}"
                            ;;
                        o*)
                            # Occupied desktop
                            wm_infos="${wm_infos}%{F$COLOR_OCCUPIED_FG}%{B$COLOR_OCCUPIED_BG}%{A:bspc desktop -f ${name}:}  ${name}  %{A}%{B-}%{F-}"
                            ;;
                        f*)
                            # Free desktop
                            wm_infos="${wm_infos}%{F$COLOR_FREE_FG}%{B$COLOR_FREE_BG}%{A:bspc desktop -f ${name}:}  ${name}  %{A}%{B-}%{F-}"
                            ;;
                        u*)
                            # Urgent desktop
                            wm_infos="${wm_infos}%{F$COLOR_URGENT_FG}%{B$COLOR_URGENT_BG}  ${name}  %{B-}%{F-}"
                            ;;
                    esac
                    shift
                done
                ;;
        esac
        printf "%s\n" "%{l}${wm_infos}${title}%{c}${music}%{r}${messages}${wifi}${volume}${battery}${date}${clock}  "
    done
}

# Dump panel into panel_bar and then into lemonbar
panel_bar < "$PANEL_FIFO" | lemonbar -g x"$PANEL_HEIGHT" -f "$PANEL_FONT" -f "$ICON_FONT" -F "$COLOR_FOREGROUND" -B "$COLOR_BACKGROUND" -u 2 | bash &

wait
